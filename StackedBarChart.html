<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stacked Bar Chart</title>
    <script src='https://d3js.org/d3.v4.min.js'></script><script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <style type="text/css">
        svg {
            font: 10px sans-serif;
            shape-rendering: crispEdges;
        }
        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
        }

        path.domain {
            stroke: none;
        }

        .y .tick line {
            stroke: #ddd;
        }
    </style>

</head>
<body>
<div>
    <button id = 'btn_transition1' onclick=plotChart(1)>Option 1</button>
    <button id = 'btn_transition2' onclick="plotChart(2)">Option 2</button>
</div>

</body>
</html>

<script>
    var groups;
    var rect;
    var benchMarkLine;
    var data = [];
    var dataset;
    var check = 1;
    var xScale, yScale, xAxis, yAxis;
    var barWidth;
    var test = true

    var margin = {top: 20, right: 160, bottom: 35, left: 30};

    var width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    var colors = ["#607aa8", "#1a3d7a"];

    var svg = d3.select("body")
        .append("svg")
        .attr("class", "svg-container")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("class", "chart")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    svg.append("path")
        .attr("d", d3.svg.symbol().type("triangle-up"));

    var rawData1 = [
        { group: "All Medical Claims", value: "327.74", benchmark: "317.23"},
        { group: "In Patient", value: "91.17", benchmark: "99.8"},
        { group: "Out Patient", value: "174.59", benchmark: "152.27"},
        { group: "Office Visit", value: "61.97", benchmark: "65.17"},
        { group: "Pharmacy Claims", value: "86.34", benchmark: "78.97"}];

    var rawData2 = getRawData(rawData1);

    onLoad();


    function onLoad(){
        getData(rawData1, 1);
        setXAxis();
        barWidth=750/data.length/2;
        plotChart(1);
    }

    function plotChart(check) {
        svg.selectAll("g.claims").remove();
        svg.selectAll("line.benchMarkLine").remove();
        var rawData = (check==1)?rawData1:rawData2;
        getData(rawData, check);
        createGroups();
        if (test) {
            test = false;
        }
        setYAxis();
        populateData(check);
        drawBenchmark();
        putLabel(check);
    }

    function getRawData(rawData) {
        var benchMarkData = [];
        rawData.forEach(function (val) {
            var a ;
            a = {group: val.group, value: (val.value/val.benchmark)*100, benchmark: 100};
            benchMarkData.push(a);
        });
        console.log(benchMarkData);
        return benchMarkData;
    }

    function getData(rawData, check) {
        data = [];
        rawData.forEach(function (val) {
            var a ;
            if(parseFloat(val.value) > parseFloat(val.benchmark)) {
                console.log(val.value +" is more than "+val.benchmark);
                a = {group: val.group, value: val.value, belowBenchMark: val.benchmark, aboveBenchMark: val.value - val.benchmark, benchmark: val.benchmark};
            }
            else{
                console.log(val.value +" is less than "+val.benchmark);
                a = {group: val.group,value: val.value, belowBenchMark: val.value, aboveBenchMark: 0, benchmark: val.benchmark};
            }
            data.push(a);
        });
        console.log(data);

        // Transpose the data into layers
        dataset = d3.layout.stack()(["belowBenchMark", "aboveBenchMark"].map(function(dataSet) {
            return data.map(function(d) {
                var label = (check==1)?d.value: (d.value-100);
                return {x: d.group, y: +d[dataSet], label: +label, xA : d.group};
            });
        }));
        console.log(dataset);
    }

    function createGroups() {
        // Create groups for each series, rects for each segment
        groups = svg.selectAll("g.claims")
            .data(dataset)
            .enter().append("g")
            .attr("class", "claims")
            .style("fill", function(d, i) { return colors[i]; });
    }

    function populateData(check) {
        
        rect = groups.selectAll("rect");

    
        var rectCount = document.getElementsByClassName("bar").length;
        console.log(rectCount);
        rect
            .data(function(d) { return d; })
            .enter()
            .append("rect")
            .attr("opacity","0.7")
            .attr("class", "bar")
            .attr("x", function(d) { return xScale(d.x); })
            .attr("y", function(d) { return yScale(d.y0 + d.y); })
            .attr("height", function(d) { return yScale(d.y0) - yScale(d.y0 + d.y); })
            .attr("width", xScale.rangeBand())
            svg.select(".y").style("opacity", check==1?1:0);
    }

    function drawBenchmark() {
   

    }

    function putLabel(check) {
        var label = groups.selectAll('text')
            .data(function(d) { return d; })
            .enter()
            .append("text")
            .text(function (d) {
                return d.label;
            })
            .attr('y', function (d) { return yScale(((check==1)? d.label: d.value) + 5) ;})
            .attr('x', function (d, i) { return xScale(d.x) + barWidth/2;})
            .attr('fill', '#A64C38');

        label.style("text-anchor","middle");
    }

    function setXAxis(){
        xScale = d3.scale.ordinal()
            .domain(dataset[0].map(function(d) { return d.x; }))
            .rangeRoundBands([10, width-10], 0.5);

        xAxis = d3.svg.axis()
            .scale(xScale)
            .orient("bottom")
            .tickFormat(function(d) { return d });

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

    }

    function setYAxis() {
        yScale = d3.scale.linear()
            .domain([0, d3.max(dataset, function(d) {  return d3.max(d, function(d) { return d.y0 + d.y; }) +50 ;  })])
            .range([height, 0]);

        yAxis = d3.svg.axis()
            .scale(yScale)
            .orient("left")
            .ticks(1)
            .tickSize(-width, 0, 0)
            .tickFormat( function(d) { return d } );

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis);
    }

       function drawBenchmark() {
        benchMarkLine = svg.selectAll('toto');
        benchMarkLine
            .data(data)
            .enter()
            .append("line")
            .attr("class", "benchMarkLine")
            .attr('x1', function (d, i) { return (2*i-1)*xScale.rangeBand()+margin.right/1.2})
            .attr("x2", function (d, i) { return (2*i)*xScale.rangeBand()+margin.right/1})
            .attr('y1', function (d, i) { return yScale(d.benchmark)})
            .attr('y2', function (d, i) { return yScale(d.benchmark)})
            .attr("stroke-width", 2)
            .attr("stroke", "#A64C38")
            .attr("fill", "none");

        svg.selectAll('.line')
            .append("path")
            .attr("d", "M1,-5.26429605180997L6.078685485212741,5.26429605180997 -6.078685485212741,5.26429605180997Z");

    }

</script>

 